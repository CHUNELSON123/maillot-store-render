@using MaillotStore.Components.Shared
@using MaillotStore.Models
@using MaillotStore.Services
@using MaillotStore.Services.Implementations
@using MaillotStore.Services.Interfaces
@inject ICartService CartService
@inject NavigationManager NavigationManager

<div class="product-card">
    <div class="product-image-container" style="position: relative;">
        <a href="/product/@Product.ProductId">
            <img src="@Product.ImageUrl" class="card-img-top" alt="@Product.Name">
        </a>

        @* --- VERSION BADGE (Top-Right) --- *@
        @if (!string.IsNullOrEmpty(Product.Version))
        {
            <div class="version-badge @GetVersionClass(Product.Version)">
                @Product.Version
            </div>
        }

        @* --- SALE BADGE (Top-Left) --- *@
        @if (Product.HasActiveDiscount || Product.IsOnSale)
        {
            <div class="position-absolute top-0 start-0 m-2 badge bg-danger sale-badge-mobile" style="z-index: 10;">
                SALE
            </div>
        }

        <AuthorizeView Roles="Influencer">
            <button @onclick="ToggleShareModal" class="product-share-icon-button">
                <i class="fas fa-share-alt"></i>
            </button>
        </AuthorizeView>
    </div>

    <div class="card-body">
        <h5 class="card-title">@Product.Name</h5>

        @* --- PRICE DISPLAY --- *@
        @if (Product.HasActiveDiscount)
        {
            <div class="price-container d-flex flex-column flex-sm-row align-items-start align-items-sm-center">
                <span class="text-muted text-decoration-line-through me-sm-2" style="font-size: 0.9em;">
                    @($"FCFA {Product.Price:N0}")
                </span>
                <span class="text-danger fw-bold">
                    @($"FCFA {Product.EffectivePrice:N0}")
                </span>
            </div>
        }
        else
        {
            <p class="card-price">@($"FCFA {Product.Price:N0}")</p>
        }

        @if (!string.IsNullOrWhiteSpace(Product.Season) && Product.Season.Trim() != "()")
        {
            <p class="card-season">@Product.Season</p>
        }
        else
        {
            <p class="card-season" style="visibility: hidden;">Placeholder</p>
        }

        <div class="d-grid gap-2">
            <a href="/product/@Product.ProductId" class="btn btn-product-action">
                <i class="fas fa-eye me-1"></i> View Details
            </a>
            <button @onclick="() => AddToCartAndNavigate(Product)" class="btn btn-product-action">
                <i class="fas fa-cart-plus me-1"></i> Add to Cart
            </button>
        </div>
    </div>
</div>

<ShareModal Product="Product" IsVisible="isShareModalVisible" OnClose="ToggleShareModal" />

<style>
    /* --- MOBILE REFINEMENTS --- */
    @@media (max-width: 576px) {
        .price-container {
            line-height: 1.2;
            margin-bottom: 8px;
        }

            .price-container span {
                display: block;
            }
        /* Prevent Truncation while staying in corners */
        .version-badge, .sale-badge-mobile {
            font-size: 0.62rem !important; /* Slightly smaller to fit full text */
            padding: 2px 4px !important;
            white-space: nowrap; /* Keep text on one line */
            overflow: visible; /* Do not hide text */
            text-overflow: clip; /* Remove the dots (...) */
            max-width: none; /* Allow full width */
        }

        .sale-badge-mobile {
            margin: 3px !important; /* Push further into corner */
        }

        .version-badge {
            top: 3px !important;
            right: 3px !important;
        }
    }

    /* Base Badge Styles */
    .version-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        z-index: 10;
        color: white;
    }

    .badge-player {
        background-color: #ffc107;
        color: #000;
    }

    .badge-retro {
        background-color: #6c757d;
    }

    .badge-training {
        background-color: #17a2b8;
    }

    .badge-fan {
        background-color: #007bff;
    }
</style>

@code {
    [Parameter]
    public Product Product { get; set; } = new();

    private bool isShareModalVisible = false;

    private void ToggleShareModal()
    {
        isShareModalVisible = !isShareModalVisible;
    }

    private void AddToCartAndNavigate(Product product)
    {
        var defaultSize = product.Size?.Split(',').FirstOrDefault()?.Trim() ?? "M";
        CartService.AddToCart(product, 1, defaultSize, null, null);
        NavigationManager.NavigateTo("/checkout");
    }

    private string GetVersionClass(string version)
    {
        if (version.Contains("Player", StringComparison.OrdinalIgnoreCase)) return "badge-player";
        if (version.Contains("Retro", StringComparison.OrdinalIgnoreCase)) return "badge-retro";
        if (version.Contains("Training", StringComparison.OrdinalIgnoreCase)) return "badge-training";
        return "badge-fan";
    }
}