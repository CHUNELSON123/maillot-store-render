@using MaillotStore.Components.Shared
@using MaillotStore.Models
@using MaillotStore.Services
@using MaillotStore.Services.Implementations
@inject StateContainer StateContainer
@inject NavigationManager NavigationManager

<div class="product-card">
    <div class="product-image-container">
        <a href="/product/@Product.ProductId">
            <img src="@Product.ImageUrl" class="card-img-top" alt="@Product.Name">
        </a>

        @* --- NEW: VERSION BADGE --- *@
        @if (!string.IsNullOrEmpty(Product.Version))
        {
            <div class="version-badge @GetVersionClass(Product.Version)">
                @Product.Version
            </div>
        }
        @* -------------------------- *@

        <AuthorizeView Roles="Influencer">
            <button @onclick="ToggleShareModal" class="product-share-icon-button">
                <i class="fas fa-share-alt"></i>
            </button>
        </AuthorizeView>
    </div>

    <div class="card-body">
        <h5 class="card-title">@Product.Name</h5>
        <p class="card-price">@($"FCFA {Product.Price:N0}")</p>

        @if (!string.IsNullOrWhiteSpace(Product.Season) && Product.Season.Trim() != "()")
        {
            <p class="card-season">@Product.Season</p>
        }
        else
        {
            <p class="card-season" style="visibility: hidden;">Placeholder</p>
        }

        <div class="d-grid gap-2">
            <a href="/product/@Product.ProductId" class="btn btn-product-action">
                <i class="fas fa-eye me-1"></i> View Details
            </a>
            <button @onclick="() => AddToCartAndNavigate(Product)" class="btn btn-product-action">
                <i class="fas fa-cart-plus me-1"></i> Add to Cart
            </button>
        </div>
    </div>
</div>

<ShareModal Product="Product" IsVisible="isShareModalVisible" OnClose="ToggleShareModal" />

@code {
    [Parameter]
    public Product Product { get; set; } = new();

    private bool isShareModalVisible = false;

    private void ToggleShareModal()
    {
        isShareModalVisible = !isShareModalVisible;
    }

    private async Task AddToCartAndNavigate(Product product)
    {
        var defaultSize = product.Size?.Split(',').FirstOrDefault()?.Trim() ?? "M";
        await StateContainer.AddToCart(product, 1, defaultSize, null, null);
        NavigationManager.NavigateTo("/checkout");
    }

    // Helper to style the badge based on version name
    private string GetVersionClass(string version)
    {
        if (version.Contains("Player", StringComparison.OrdinalIgnoreCase)) return "badge-player";
        if (version.Contains("Retro", StringComparison.OrdinalIgnoreCase)) return "badge-retro";
        if (version.Contains("Training", StringComparison.OrdinalIgnoreCase)) return "badge-training";
        return "badge-fan"; // Default
    }
}