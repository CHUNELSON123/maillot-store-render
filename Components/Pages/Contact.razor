@page "/contact"
@using System.ComponentModel.DataAnnotations
@using System.Web
@using MaillotStore.Data
@using Microsoft.EntityFrameworkCore
@inject NavigationManager NavigationManager
@inject ApplicationDbContext DbContext
@rendermode InteractiveServer

<div class="contact-us-container">
    <h1 class="contact-title">Contact Us</h1>
    <p class="contact-intro">
        Here at Maillot, we prioritize customer satisfaction which is why we have a support system that’s available 24/7 to tend to all of your needs.
    </p>

    <div class="contact-body">

        @* --- "GET IN TOUCH" SECTION (FIRST) --- *@
        <div class="contact-info-section">
            <h3 class="info-title">Get In Touch</h3>
            <ul class="info-list">
                <li>
                    <span class="icon"><i class="fa-solid fa-phone"></i></span>

                    <p>+237 690 05 91 97</p>
                </li>
                <li>
                    <span class="icon"><i class="fa-brands fa-whatsapp"></i></span>
                    <p>+237 90059197</p>

                </li>
                <li>
                    <span class="icon"><i class="fa-solid fa-envelope"></i></span>
                    <p>maillotstore@gmail.com</p>
                </li>

                <li>
                    <span class="icon"><i class="fa-solid fa-location-dot"></i></span>
                    <p>Douala, Cameroon</p>
                </li>
            </ul>

            <h3 class="info-title social-links-title">Social Links</h3>

            <div class="social-icons">
                <a href="https://wa.me/23790059197" target="_blank"><i class="fab fa-whatsapp"></i></a>
                <a href="https://www.instagram.com/maillotstorecm?igsh=MWRveGdudzZiMmN3dw%3D%3D&utm_source=qr" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://www.tiktok.com/maillotstore.cm?_r=1&_t=ZM-92zJpTLoOcO" target="_blank"><i class="fab fa-tiktok"></i></a>
                <a href="https://www.facebook.com/share/1CNhfJ9xaa/?mibextid=wwXIfr" target="_blank"><i class="fab fa-facebook-f"></i></a>
                <a href="https://snapchat.com/t/7TCZOspT" target="_blank"><i class="fab fa-snapchat-ghost"></i></a>
                <a href="https://x.com/maillotstorecm?s=21" target="_blank"><i class="fab fa-x-twitter"></i></a>


            </div>
        </div>

        @* --- "SEND US A 
 MESSAGE" SECTION (SECOND) --- *@
        @* --- FIX: Added centering classes --- *@
        <div class="contact-form-section px-0 mx-0 px-md-3">
            <h3 class="form-title">Send Us A Message</h3>

            <EditForm Model="@contactForm" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />


                <div class="form-group">
                    <InputText @bind-Value="contactForm.Name" class="form-control" placeholder="Name" />
                </div>
                <div class="form-group">
                    <InputText @bind-Value="contactForm.ContactInfo" class="form-control" placeholder="Phone Number" />

                </div>
                <div class="form-group">
                    <InputTextArea @bind-Value="contactForm.Message" class="form-control" rows="8" placeholder="Message" />
                </div>
                <button type="submit" class="submit-message-btn">SUBMIT</button>

            </EditForm>
        </div>
    </div>
</div>

@code {
    private ContactForm contactForm = new();
    private string adminWhatsAppNumber = ""; // Will be loaded from DB

    protected override async Task OnInitializedAsync()
    {
        // Load the admin WhatsApp number from the AdminSettings table
        var setting = await DbContext.AdminSettings
            .AsNoTracking()
            .FirstOrDefaultAsync(s => s.Key == "AdminWhatsAppNumber");

        if (setting != null && !string.IsNullOrWhiteSpace(setting.Value))
        {
            adminWhatsAppNumber = setting.Value;
        }
    }

    private void HandleSubmit()
    {
        // Check if the contact info is an email or a phone number
        if (contactForm.ContactInfo.Contains("@"))
        {
            // It's an email, create a mailto link
            var subject = HttpUtility.UrlEncode($"Message from {contactForm.Name}");
            var body = HttpUtility.UrlEncode(contactForm.Message);
            var mailtoUrl = $"mailto:maillotstore32@gmail.com?subject={subject}&body={body}";
            NavigationManager.NavigateTo(mailtoUrl, forceLoad: true);
        }
        else
        {
            // It's a phone number, create a WhatsApp link
            var text = HttpUtility.UrlEncode($"Name: {contactForm.Name}\nMessage: {contactForm.Message}");

            // *** UPDATED LINE ***
            // Use the loaded admin number. Remove '+' and spaces for the wa.me URL.
            var whatsAppNumberForUrl = adminWhatsAppNumber.Replace("+", "").Replace(" ", "");
            var whatsappUrl = $"https://wa.me/{whatsAppNumberForUrl}?text={text}";

            NavigationManager.NavigateTo(whatsappUrl, forceLoad: true);
        }

        // Reset the form after submission
        contactForm = new();
    }

    public class ContactForm
    {
        [Required]
        public string Name
        {
            get;
            set;
        }

        [Required(ErrorMessage = "Please enter your email or phone number.")]
        public string ContactInfo
        {
            get;
            set;
        }

        [Required]
        public string Message
        {
            get;
            set;
        }
    }
}