@page "/"
@rendermode InteractiveServer
@using MaillotStore.Components.Account.Shared
@using MaillotStore.Models
@using MaillotStore.Data
@using MaillotStore.Services.Interfaces
@using Microsoft.EntityFrameworkCore
@inject IProductService ProductService
@inject ITeamService TeamService
@inject IMarketingService MarketingService
@implements IDisposable

<PageTitle>Home</PageTitle>

@* --- HERO BANNER --- *@
<div class="hero-banner" style="background-image: url(@currentHeroUrl); transition: background-image 0.8s ease-in-out;">
    <div class="hero-content">
        <h2>Official Jerseys. Unbeatable Style.</h2>
        <p>Discover premium football jerseys at Maillot Store. Wear your passion and support your team in style.</p>
        <h3>"Your Premier Destination for Authentic Jerseys" </h3>
        <a href="/shop" class="btn btn-lg cta-button">
            <i class="fas fa-shopping-cart me-2"></i> Shop Now
        </a>
    </div>
</div>

@* --- TOP TEAMS SECTION --- *@
<section class="container mt-5">
    <h2 class="text-center mb-4">Top Teams</h2>
    @if (topTeams == null)
    {
        <p class="text-center">Loading teams...</p>
    }
    else if (topTeams.Any())
    {
        <div class="teams-wrapper">
            @foreach (var team in topTeams)
            {
                <a href="/shop?teamId=@team.Id" class="team-item">
                    <div class="logo-wrapper">
                        <img src="@team.LogoUrl" alt="@team.Name" />
                    </div>
                    <p class="team-name">@team.Name</p>
                </a>
            }
        </div>
    }
</section>

@* --- FEATURED JERSEYS --- *@
<section class="featured-jerseys container section-spacer">
    <h2 class="text-center mb-4">Featured Jerseys</h2>
    @if (featuredProducts is not null)
    {
        <div class="row g-4">
            @foreach (var product in featuredProducts)
            {
                <div class="col-6 col-lg-4">
                    <ProductCard Product="product" />
                </div>
            }
        </div>
    }
</section>

@* --- WHY CHOOSE US SECTION --- *@
<section class="why-choose-us container section-spacer">
    <h2 class="text-center mb-4">Why Choose Us?</h2>
    <div class="row justify-content-center g-4">
        <div class="col-6 col-lg-4">
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-check-circle"></i></div>
                <h3>Authenticity Guaranteed</h3>
                <p>Original quality guaranteed from official suppliers.</p>
            </div>
        </div>
        <div class="col-6 col-lg-4">
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-shipping-fast"></i></div>
                <h3>Fast & Reliable Delivery</h3>
                <p>Get your jersey delivered quickly and reliable, no matter where you are.</p>
            </div>
        </div>
        <div class="col-6 col-lg-4">
            <div class="feature-card">
                <div class="feature-icon"><i class="fas fa-mouse-pointer"></i></div>
                <h3>Easy Ordering Process</h3>
                <p> Our user-friendly platform makes ordering your favorite jerseys a breeze.</p>
            </div>
        </div>
    </div>
</section>

@* --- BECOME AN INFLUENCER SECTION --- *@
<section class="influencer-cta section-spacer">
    <div class="container text-center">
        <h2>Become an Influencer</h2>
        <p class="lead"> Promote our jerseys, share your unique link, and earn commissions on every sale. Join the Maillot Store family today.</p>
        <a href="/Account/Register" class="btn btn-lg cta-button-influencer" data-no-enhance>SignUp Now</a>
    </div>
</section>

@* --- SHOP SHOWCASE SECTION --- *@
<section class="shop-showcase section-spacer container pb-5">
    <h2 class="text-center mb-4">Inside Our Shop</h2>
    @if (showcaseAssets != null && showcaseAssets.Any())
    {
        <div class="showcase-grid">
            @foreach (var asset in showcaseAssets)
            {
                <div class="showcase-card" @onclick="() => OpenLightbox(asset)" style="cursor: zoom-in;">
                    @if (asset.MediaType == "Video")
                    {
                        @if (asset.Url.Contains("youtube.com") || asset.Url.Contains("youtu.be"))
                        {
                            <div class="ratio ratio-16x9">
                                <iframe src="@GetEmbedUrl(asset.Url)" title="Shop Video" allowfullscreen style="pointer-events: none;"></iframe>
                            </div>
                        }
                        else
                        {
                            <div class="ratio ratio-16x9">
                                <video muted playsinline style="width:100%; height:100%; border-radius: 8px; object-fit: cover;">
                                    <source src="@asset.Url" type="video/mp4">
                                </video>
                            </div>
                        }
                    }
                    else
                    {
                        <img src="@asset.Url" alt="Shop Photo" loading="lazy" />
                    }
                </div>
            }
        </div>
    }
</section>

@* --- LIGHTBOX OVERLAY --- *@
@if (isLightboxOpen && selectedAsset != null)
{
    <div class="lightbox-overlay" @onclick="CloseLightbox">
        <div class="lightbox-content" @onclick:stopPropagation>
            <button class="lightbox-close" @onclick="CloseLightbox">&times;</button>

            @if (selectedAsset.MediaType == "Video")
            {
                @if (selectedAsset.Url.Contains("youtube.com") || selectedAsset.Url.Contains("youtu.be"))
                {
                    <div class="ratio ratio-16x9" style="width: 80vw; max-width: 1000px;">
                        <iframe src="@GetEmbedUrl(selectedAsset.Url, true)" title="Shop Video" allowfullscreen allow="autoplay"></iframe>
                    </div>
                }
                else
                {
                    <video controls autoplay playsinline style="max-width: 90vw; max-height: 80vh; border-radius: 8px;">
                        <source src="@selectedAsset.Url" type="video/mp4">
                    </video>
                }
            }
            else
            {
                <img src="@selectedAsset.Url" alt="Zoomed Shop Photo" style="max-width: 90vw; max-height: 85vh; object-fit: contain; border-radius: 4px;" />
            }
        </div>
    </div>
}

<style>
    /* --- LIGHTBOX STYLES --- */
    .lightbox-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s;
    }

    .lightbox-content {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .lightbox-close {
        position: absolute;
        top: -50px;
        right: 0;
        background: none;
        border: none;
        color: white;
        font-size: 3rem;
        cursor: pointer;
    }

    /* --- SHOP SHOWCASE GRID --- */
    .showcase-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
    }

    .showcase-card {
        border-radius: 8px;
        overflow: hidden;
        background: #1a1a1a;
        transition: transform 0.3s;
    }

        .showcase-card:hover {
            transform: scale(1.02);
        }

        .showcase-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

    @@media (max-width: 992px) {
        .showcase-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 576px) {
        .showcase-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .showcase-card img {
            height: 180px;
        }

        .lightbox-close {
            top: -40px;
            right: 10px;
        }
    }

    /* --- TEAMS STYLES (Your Original) --- */
    .teams-wrapper {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px 15px;
        padding: 10px 10px;
    }

    .team-item {
        flex: 0 0 auto;
        width: 80px;
        text-align: center;
        text-decoration: none;
        color: inherit;
    }

    .logo-wrapper img {
        width: 100%;
        height: 80px;
        object-fit: contain;
        filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
    }

    .team-name {
        margin-top: 8px;
        font-weight: bold;
        font-size: 0.8rem;
        color: inherit;
        white-space: normal;
        line-height: 1.1;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
</style>

@code {
    private List<Product>? featuredProducts;
    private List<Team>? topTeams;
    private System.Threading.Timer? _timer;
    private int _currentImageIndex = 0;

    private List<string> _heroImages = new();
    private string currentHeroUrl => _heroImages.Any() ? _heroImages[_currentImageIndex] : "";
    private List<MarketingAsset> showcaseAssets;

    // Lightbox State
    private bool isLightboxOpen = false;
    private MarketingAsset? selectedAsset;

    protected override async Task OnInitializedAsync()
    {
        topTeams = (await TeamService.GetHomeDisplayTeamsAsync()).Take(14).ToList();
        featuredProducts = await ProductService.GetFeaturedProductsAsync();

        var banners = await MarketingService.GetAssetsBySectionAsync("HeroBanner");
        if (banners.Any()) _heroImages = banners.Select(b => b.Url).ToList();
        else _heroImages.Add("https://m.media-amazon.com/images/I/71izjNHcVhL._AC_SL1500_.jpg");

        showcaseAssets = await MarketingService.GetAssetsBySectionAsync("ShopShowcase");

        _timer = new System.Threading.Timer(ChangeImage, null, 0, 3000);
    }

    private void ChangeImage(object? state)
    {
        if (_heroImages.Count > 1)
        {
            _currentImageIndex = (_currentImageIndex + 1) % _heroImages.Count;
            InvokeAsync(StateHasChanged);
        }
    }

    private void OpenLightbox(MarketingAsset asset)
    {
        selectedAsset = asset;
        isLightboxOpen = true;
    }

    private void CloseLightbox()
    {
        isLightboxOpen = false;
        selectedAsset = null;
    }

    private string GetEmbedUrl(string url, bool autoplay = false)
    {
        if (string.IsNullOrWhiteSpace(url)) return "";
        string videoId = "";

        if (url.Contains("youtube.com/watch?v=")) videoId = url.Split("v=")[1].Split("&")[0];
        else if (url.Contains("youtu.be/")) videoId = url.Split("youtu.be/")[1];
        else return url;

        return $"https://www.youtube.com/embed/{videoId}{(autoplay ? "?autoplay=1" : "")}";
    }

    public void Dispose() => _timer?.Dispose();
}