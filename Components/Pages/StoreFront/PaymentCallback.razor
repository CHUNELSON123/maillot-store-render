@page "/payment-callback"
@using MaillotStore.Data
@using MaillotStore.Models
@using MaillotStore.Services.Implementations
@using MaillotStore.Services.Interfaces
@using Microsoft.EntityFrameworkCore
@using System.Net
@using System.Net.Mail
@using System.Text
@inject NavigationManager NavigationManager
@inject NotchPayService NotchPayService
@inject WhatsAppService WhatsAppService
@inject ICartService CartService
@inject IOrderStateService OrderStateService
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IConfiguration Configuration
@inject ILogger<PaymentCallback> Logger

<div class="container my-5 text-center">
    @if (isLoading)
    {
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-white">Verifying your payment...</p>
    }
    else if (paymentStatus == "complete")
    {
        <div class="card shadow-sm p-5 bg-dark text-white border-success mx-auto position-relative" style="max-width: 600px;">
            <a href="/shop" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" aria-label="Close" style="text-decoration:none;"></a>

            <div class="mb-4 text-success">
                <i class="fas fa-check-circle fa-5x"></i>
            </div>
            <h2 class="mb-3">Payment Successful!</h2>
            <p>Thank you for your order. We have received your payment.</p>
            <p><strong>Order Reference:</strong> @reference</p>
            <div class="mt-4">
                <a href="/shop" class="btn btn-light btn-lg">Continue Shopping</a>
            </div>
        </div>
    }
    else
    {
        <div class="card shadow-sm p-5 bg-dark text-white border-danger mx-auto position-relative" style="max-width: 600px;">
            <a href="/checkout" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" aria-label="Close" style="text-decoration:none;"></a>
            <div class="mb-4 text-danger">
                <a href="/checkout" class="text-danger">
                    <i class="fas fa-times-circle fa-5x"></i>
                </a>
            </div>
            <h2 class="mb-3">Payment Failed or Canceled</h2>
            <p>We could not verify your payment. Your cart has been saved.</p>
            <div class="mt-4">
                <a href="/checkout" class="btn btn-outline-danger">Return to Checkout</a>
            </div>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery]
    public string? reference { get; set; }

    private bool isLoading = true;
    private string? paymentStatus = null;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(reference))
        {
            isLoading = false;
            return;
        }

        Logger.LogInformation($"Processing payment callback for reference: {reference}");

        // 1. Verify Payment
        paymentStatus = await NotchPayService.VerifyPaymentAsync(reference);

        if (paymentStatus == "complete")
        {
            using var context = DbFactory.CreateDbContext();

            var order = await context.Orders
                .Include(o => o.OrderItems)
                .ThenInclude(oi => oi.Product)
                .FirstOrDefaultAsync(o => o.PaymentReference == reference);

            if (order != null)
            {
                if (order.PaymentStatus != "Paid")
                {
                    order.PaymentStatus = "Paid";
                    order.Status = "Processing";
                    await context.SaveChangesAsync();

                    Logger.LogInformation($"Order {order.Id} marked as Paid.");

                    // NOW we clear the cart! (Because payment succeeded)
                    CartService.ClearCart();
                    OrderStateService.ClearStagedOrder();

                    // --- SPEED FIX: Run WhatsApp in Background ---
                    _ = Task.Run(async () =>
                    {
                        try
                        {
                            await WhatsAppService.SendOrderNotificationsAsync(order);
                            await SendAdminEmailAsync(order);
                        }
                        catch (Exception ex)
                        {
                            Logger.LogError(ex, "Background notification failed");
                        }
                    });
                    // ---------------------------------------------
                }
                else
                {
                    // If the user refreshed the success page, just make sure the cart is clear
                    CartService.ClearCart();
                    OrderStateService.ClearStagedOrder();
                }
            }
        }
        else if (paymentStatus == "canceled")
        {
            // Payment failed or user canceled. We do NOT clear the cart.
            // Just return them to the checkout page.
            NavigationManager.NavigateTo("/checkout");
            return;
        }

        isLoading = false;
    }

    private async Task SendAdminEmailAsync(Order order)
    {
        try
        {
            var smtpSettings = Configuration.GetSection("SmtpSettings");
            var server = smtpSettings["Server"];
            var portStr = smtpSettings["Port"];
            var username = smtpSettings["Username"];
            var password = smtpSettings["Password"];

            if (string.IsNullOrEmpty(server) || string.IsNullOrEmpty(username)) return;

            int port = int.TryParse(portStr, out int p) ? p : 587;

            var sb = new StringBuilder();
            sb.AppendLine($"New Order #{order.Id} Paid via NotchPay!");
            sb.AppendLine($"Amount: {order.TotalAmount:N0} XAF");

            using var message = new MailMessage();
            message.From = new MailAddress(username, "Maillot Store");
            message.To.Add("contact@maillotstore.store");
            message.Subject = $"Order #{order.Id} - Paid";
            message.Body = sb.ToString();

            using var client = new SmtpClient(server, port);
            client.EnableSsl = true;
            client.Credentials = new NetworkCredential(username, password);
            await client.SendMailAsync(message);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to send admin email.");
        }
    }
}