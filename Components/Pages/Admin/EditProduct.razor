@page "/admin/edit-product/{ProductId:int}"
@using System.IO
@using MaillotStore.Components.Layout
@using MaillotStore.Data
@using MaillotStore.Models
@using MaillotStore.ViewModels
@using MaillotStore.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@layout AdminLayout
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment Environment
@inject ILogger<EditProduct> Logger
@inject ITeamService TeamService
@inject ILeagueService LeagueService
@inject MaillotStore.Services.Implementations.CloudinaryService CloudinaryService
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Edit Product</PageTitle>

<div class="add-product-container">
    <div class="add-product-header">
        <h1>Edit Product</h1>
        <button class="back-btn" @onclick='() => NavigationManager.NavigateTo("/admin/products")'>Back</button>
    </div>

    <div class="add-product-form-body">
        @if (productViewModel == null)
        {
            <p><em>Loading product...</em></p>
        }
        else
        {
            <EditForm Model="@productViewModel" OnValidSubmit="HandleUpdateSubmit" enctype="multipart/form-data">
                <DataAnnotationsValidator />

                @* --- BASIC FIELDS --- *@
                <div class="form-group">
                    <label for="productName">Product Name:</label>
                    <InputText id="productName" class="form-control-dark" @bind-Value="productViewModel.Name" />
                    <ValidationMessage For="@(() => productViewModel.Name)" />
                </div>

                <div class="form-group">
                    <label for="productPrice">Price:</label>
                    <InputNumber id="productPrice" class="form-control-dark" @bind-Value="productViewModel.Price" />
                    <ValidationMessage For="@(() => productViewModel.Price)" />
                </div>

                <div class="form-group">
                    <label for="productCategory">Category:</label>
                    <InputSelect id="productCategory" class="form-control-dark" @bind-Value="productViewModel.Category">
                        <option value="">Select Category</option>
                        <option value="Football">Football</option>
                        <option value="Basketball">Basketball</option>
                        <option value="NFL">NFL</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => productViewModel.Category)" />
                </div>

                <div class="form-group">
                    <label for="productVersion">Jersey Version (Optional):</label>
                    <InputSelect id="productVersion" class="form-control-dark" @bind-Value="productViewModel.Version">
                        <option value="">-- None / Standard --</option>
                        <option value="Fan Version">Fan Version</option>
                        <option value="Player Version">Player Version</option>
                        <option value="Retro">Retro</option>
                        <option value="Training">Training</option>
                    </InputSelect>
                </div>

                @* --- NEW: LEAGUE SELECTION (Saves directly to Product) --- *@
                <div class="form-group">
                    <label>League (Optional):</label>
                    @* We use InputSelect linked to ViewModel.LeagueId *@
                    <InputSelect class="form-control-dark" Value="@productViewModel.LeagueId" ValueExpression="@(() => productViewModel.LeagueId)" ValueChanged="@((int? value) => OnLeagueChanged(value))">
                        <option value="">-- Select League --</option>
                        @if (leagues != null)
                        {
                            @foreach (var league in leagues)
                            {
                                <option value="@league.Id">@league.Name</option>
                            }
                        }
                    </InputSelect>
                </div>

                <div class="form-group">
                    <label for="productTeam">Team (Optional):</label>
                    <InputSelect id="productTeam" class="form-control-dark" @bind-Value="productViewModel.TeamId">
                        <option value="">-- Select Team --</option>
                        @if (filteredTeams != null)
                        {
                            @foreach (var team in filteredTeams)
                            {
                                <option value="@team.Id">@team.Name</option>
                            }
                        }
                    </InputSelect>
                </div>

                @* --- REST OF THE FORM --- *@
                <div class="form-group">
                    <label for="jerseySeason">Jersey Season:</label>
                    <div class="season-inputs">
                        <InputSelect class="form-control-dark" @bind-Value="productViewModel.SeasonType">
                            <option value="">Select Type</option>
                            <option value="HOME">HOME</option>
                            <option value="AWAY">AWAY</option>
                            <option value="THIRD">THIRD</option>
                        </InputSelect>
                        <InputSelect class="form-control-dark" @bind-Value="productViewModel.SeasonYear">
                            <option value="">Select Year</option>
                            @foreach (var year in SeasonYears)
                            {
                                <option value="@year">@year</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <div class="form-group">
                    <label for="stockQuantity">Stock Quantity:</label>
                    <InputNumber id="stockQuantity" class="form-control-dark" @bind-Value="productViewModel.Stock" />
                </div>

                <div class="form-group">
                    <label for="productDescription">Description:</label>
                    <InputTextArea id="productDescription" class="form-control-dark" rows="5" @bind-Value="productViewModel.Description" />
                </div>

                @* --- IMAGE UPLOAD SECTIONS --- *@
                <div class="form-group">
                    <label style="font-weight:bold; margin-bottom: 8px; display:block;">Main Product Image</label>
                    <div class="input-row" style="gap: 10px; align-items: center;">
                        <InputText class="form-control-dark" @bind-Value="productViewModel.ImageUrl" placeholder="Paste URL or upload file..." style="flex: 1;" />
                        <label class="btn-saved" style="cursor: pointer; margin:0; padding: 10px 15px; display:flex; align-items:center;">
                            @if (isUploadingMain)
                            {
                                <span>Uploading...</span>
                            }
                            else
                            {

                                <span>Upload</span>
                            }
                            <InputFile OnChange="LoadMainImage" hidden accept=".jpg,.jpeg,.png,.webp" />
                        </label>
                    </div>
                    @if (!string.IsNullOrEmpty(productViewModel.ImageUrl))
                    {
                        <div style="margin-top: 10px; border: 1px solid #444; padding: 5px; border-radius: 4px; display: inline-block;">
                            <img src="@productViewModel.ImageUrl" style="max-height: 150px; object-fit: cover;" />
                        </div>
                    }
                </div>

                <div class="form-group">
                    <label style="font-weight:bold; margin-bottom: 8px; display:block;">Gallery Images (Unlimited)</label>
                    <div style="margin-bottom: 10px;">
                        <label class="btn-saved" style="cursor: pointer; margin-right: 10px;">
                            + Upload Multiple Images
                            <InputFile OnChange="LoadGalleryImages" multiple hidden accept=".jpg,.jpeg,.png,.webp" />
                        </label>
                        <button type="button" class="btn-cancel" @onclick="AddEmptyGallerySlot">
                            + Add URL Manually
                        </button>
                    </div>
                    @if (isUploadingGallery)
                    {
                        <p><em>Uploading images...</em></p>
                    }

                    @foreach (var image in productViewModel.Gallery)
                    {
                        <div class="input-row" style="margin-bottom: 10px; align-items: center;">
                            <span style="color: #fff; margin-right: 10px;">Img:</span>
                            <InputText class="form-control-dark" @bind-Value="image.ImageUrl" placeholder="Image URL" style="flex: 1;" />
                            @if (!string.IsNullOrEmpty(image.ImageUrl))
                            {
                                <div style="width: 50px; height: 38px; margin: 0 10px; overflow: hidden; border: 1px solid #555;">
                                    <img src="@image.ImageUrl" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'" />
                                </div>
                            }
                            <button type="button" class="btn-cancel" style="background-color: #dc3545; border:none;" @onclick="() => RemoveGalleryImage(image)">X</button>
                        </div>
                    }
                </div>

                <div class="form-group featured-group">
                    <label>Featured:</label>
                    <div class="featured-options">
                        <InputRadioGroup @bind-Value="productViewModel.IsFeatured">
                            <div class="form-check">
                                <InputRadio class="form-check-input" id="featuredYes" Value="true" />
                                <label class="form-check-label" for="featuredYes">Yes</label>
                            </div>
                            <div class="form-check">
                                <InputRadio class="form-check-input" id="featuredNo" Value="false" />
                                <label class="form-check-label" for="featuredNo">No</label>
                            </div>
                        </InputRadioGroup>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-saved" disabled="@(isUploadingMain || isUploadingGallery)">Update</button>
                    <button type="button" class="btn-cancel" @onclick='() => NavigationManager.NavigateTo("/admin/products")'>Cancel</button>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public int ProductId { get; set; }
    private ProductViewModel? productViewModel;
    private List<string> SeasonYears { get; set; } = new();

    private List<Team> allTeams = new();
    private List<League> leagues = new();

    // We filter teams based on the selected LeagueId in the ViewModel
    private IEnumerable<Team> filteredTeams =>
        (productViewModel?.LeagueId == null || productViewModel.LeagueId == 0)
        ? allTeams
        : allTeams.Where(t => t.LeagueId == productViewModel.LeagueId);

    private bool isUploadingMain = false;
    private bool isUploadingGallery = false;

    protected override async Task OnInitializedAsync()
    {
        leagues = await LeagueService.GetAllLeaguesAsync();
        allTeams = await TeamService.GetAllTeamsAsync();

        int startYear = 2014;
        int currentYear = DateTime.Now.Year;
        for (int year = startYear; year <= currentYear; year++)
        {
            SeasonYears.Add($"{year}/{year + 1}");
        }
        SeasonYears.Reverse();

        var product = await DbContext.Products
            .Include(p => p.Gallery)
            .Include(p => p.Team) // Include Team to get League if needed
            .FirstOrDefaultAsync(p => p.ProductId == ProductId);

        if (product != null)
        {
            productViewModel = new ProductViewModel
            {
                Name = product.Name,
                Price = product.Price,
                Category = product.Category,
                Stock = product.Stock,
                Description = product.Description,
                IsFeatured = product.IsFeatured,
                ImageUrl = product.ImageUrl,
                Gallery = product.Gallery.ToList(),
                TeamId = product.TeamId,
                Version = product.Version,

                // --- LOAD LEAGUE: Prioritize direct LeagueId, fallback to Team's League ---
                LeagueId = product.LeagueId ?? product.Team?.LeagueId
            };

            if (!string.IsNullOrEmpty(product.Season) && product.Season.Contains(" (") && product.Season.EndsWith(")"))
            {
                var parts = product.Season.Split(new[] { " (" }, StringSplitOptions.None);
                if (parts.Length == 2)
                {
                    productViewModel.SeasonType = parts[0];
                    productViewModel.SeasonYear = parts[1].TrimEnd(')');
                }
            }
            else if (!string.IsNullOrEmpty(product.Season))
            {
                productViewModel.SeasonType = product.Season;
            }
        }
    }

    // --- LOGIC: When League Changes ---
    private void OnLeagueChanged(int? newLeagueId)
    {
        if (productViewModel != null)
        {
            productViewModel.LeagueId = newLeagueId;
            // Clear Team if it doesn't match the new League
            if (productViewModel.TeamId.HasValue)
            {
                var currentTeam = allTeams.FirstOrDefault(t => t.Id == productViewModel.TeamId.Value);
                if (currentTeam != null && currentTeam.LeagueId != newLeagueId)
                {
                    productViewModel.TeamId = null;
                }
            }
        }
    }

    private async Task LoadMainImage(InputFileChangeEventArgs e)
    {
        isUploadingMain = true;
        try { productViewModel.ImageUrl = await UploadFileAsync(e.File); }
        finally { isUploadingMain = false; }
    }

    private async Task LoadGalleryImages(InputFileChangeEventArgs e)
    {
        isUploadingGallery = true;
        try
        {
            var files = e.GetMultipleFiles(10);
            var tasks = files.Select(file => UploadFileAsync(file));
            var uploadedUrls = await Task.WhenAll(tasks);

            foreach (var url in uploadedUrls)
            {
                productViewModel.Gallery.Add(new ProductImage { ImageUrl = url, ProductId = ProductId });
            }
        }
        finally { isUploadingGallery = false; }
    }

    private async Task<string> UploadFileAsync(IBrowserFile file)
    {
        var url = await CloudinaryService.UploadImageAsync(file);
        if (string.IsNullOrEmpty(url)) throw new Exception("Upload failed.");
        return url;
    }

    private void AddEmptyGallerySlot() => productViewModel.Gallery.Add(new ProductImage());
    private void RemoveGalleryImage(ProductImage image) => productViewModel.Gallery.Remove(image);

    private async Task HandleUpdateSubmit()
    {
        var productToUpdate = await DbContext.Products
            .Include(p => p.Gallery)
            .FirstOrDefaultAsync(p => p.ProductId == ProductId);

        if (productToUpdate == null || productViewModel == null) return;

        productToUpdate.Name = productViewModel.Name;
        productToUpdate.Price = productViewModel.Price;
        productToUpdate.Category = productViewModel.Category;
        productToUpdate.Stock = productViewModel.Stock;
        productToUpdate.Description = productViewModel.Description;
        productToUpdate.IsFeatured = productViewModel.IsFeatured;
        productToUpdate.ImageUrl = productViewModel.ImageUrl;
        productToUpdate.TeamId = productViewModel.TeamId;
        productToUpdate.Version = productViewModel.Version;

        // --- SAVE LEAGUE ID ---
        productToUpdate.LeagueId = productViewModel.LeagueId;
        // ----------------------

        productToUpdate.Season = !string.IsNullOrEmpty(productViewModel.SeasonType)
             ? $"{productViewModel.SeasonType}{(!string.IsNullOrEmpty(productViewModel.SeasonYear) ? $" ({productViewModel.SeasonYear})" : "")}"
             : null;

        var validIds = productViewModel.Gallery.Where(g => g.Id != 0).Select(g => g.Id).ToList();
        var toRemove = productToUpdate.Gallery.Where(g => !validIds.Contains(g.Id)).ToList();
        DbContext.ProductImages.RemoveRange(toRemove);

        foreach (var imgVM in productViewModel.Gallery)
        {
            if (imgVM.Id == 0 && !string.IsNullOrWhiteSpace(imgVM.ImageUrl))
            {
                productToUpdate.Gallery.Add(new ProductImage { ImageUrl = imgVM.ImageUrl });
            }
        }

        await DbContext.SaveChangesAsync();
        NavigationManager.NavigateTo("/admin/products");
    }
}