@page "/admin/edit-product/{ProductId:int}"
@using System.IO
@using MaillotStore.Components.Layout
@using MaillotStore.Data
@using MaillotStore.Models
@using MaillotStore.ViewModels
@using MaillotStore.ViewModels
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@layout AdminLayout
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment Environment
@inject ILogger<EditProduct> Logger
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Edit Product</PageTitle>

<div class="add-product-container">
    <div class="add-product-header">
        <h1>Edit Product</h1>
        <button class="back-btn" @onclick='() => NavigationManager.NavigateTo("/admin/products")'>Back</button>
    </div>

    <div class="add-product-form-body">
        @if (productViewModel == null)
        {
            <p><em>Loading product...</em></p>
        }
        else
        {
            <EditForm Model="@productViewModel" OnValidSubmit="HandleUpdateSubmit" enctype="multipart/form-data">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label for="productName">Product Name:</label>
                    <InputText id="productName" class="form-control-dark" @bind-Value="productViewModel.Name" />
                    <ValidationMessage For="@(() => productViewModel.Name)" />
                </div>

                <div class="form-group">
                    <label for="productPrice">Price:</label>
                    <InputNumber id="productPrice" class="form-control-dark" @bind-Value="productViewModel.Price" />
                    <ValidationMessage For="@(() => productViewModel.Price)" />
                </div>

                <div class="form-group">
                    <label for="productCategory">Category:</label>
                    <InputSelect id="productCategory" class="form-control-dark" @bind-Value="productViewModel.Category">
                        <option value="">Select Category</option>
                        <option value="Football">Football</option>
                        <option value="Basketball">Basketball</option>
                        <option value="NFL">NFL</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => productViewModel.Category)" />
                </div>

                <div class="form-group">
                    <label for="jerseySeason">Jersey Season:</label>
                    <div class="season-inputs">
                        <InputSelect class="form-control-dark" @bind-Value="productViewModel.SeasonType">
                            <option value="">Select Type</option>
                            <option value="HOME">HOME</option>
                            <option value="AWAY">AWAY</option>
                            <option value="THIRD">THIRD</option>
                        </InputSelect>
                        <InputSelect class="form-control-dark" @bind-Value="productViewModel.SeasonYear">
                            <option value="">Select Year</option>
                            @foreach (var year in SeasonYears)
                            {
                                <option value="@year">@year</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <div class="form-group">
                    <label for="stockQuantity">Stock Quantity:</label>
                    <InputNumber id="stockQuantity" class="form-control-dark" @bind-Value="productViewModel.Stock" />
                </div>

                <div class="form-group">
                    <label for="productDescription">Description:</label>
                    <InputTextArea id="productDescription" class="form-control-dark" rows="5" @bind-Value="productViewModel.Description" />
                </div>

                <div class="form-group">
                    <label style="font-weight:bold; margin-bottom: 8px; display:block;">Main Product Image</label>
                    <div class="input-row" style="gap: 10px; align-items: center;">
                        <InputText class="form-control-dark" @bind-Value="productViewModel.ImageUrl" placeholder="Paste URL or upload file..." style="flex: 1;" />
                        <label class="btn-saved" style="cursor: pointer; margin:0; padding: 10px 15px; display:flex; align-items:center;">
                            @if (isUploadingMain) { <span>Uploading...</span> } else { <span>Upload</span> }
                            <InputFile OnChange="LoadMainImage" hidden accept=".jpg,.jpeg,.png,.webp" />
                        </label>
                    </div>
                    @if (!string.IsNullOrEmpty(productViewModel.ImageUrl))
                    {
                        <div style="margin-top: 10px; border: 1px solid #444; padding: 5px; border-radius: 4px; display: inline-block;">
                            <img src="@productViewModel.ImageUrl" style="max-height: 150px; object-fit: cover;" />
                        </div>
                    }
                </div>

                <div class="form-group">
                    <label style="font-weight:bold; margin-bottom: 8px; display:block;">Gallery Images (Unlimited)</label>
                    <div style="margin-bottom: 10px;">
                        <label class="btn-saved" style="cursor: pointer; margin-right: 10px;">
                            + Upload Multiple Images
                            <InputFile OnChange="LoadGalleryImages" multiple hidden accept=".jpg,.jpeg,.png,.webp" />
                        </label>
                        <button type="button" class="btn-cancel" @onclick="AddEmptyGallerySlot">
                            + Add URL Manually
                        </button>
                    </div>

                    @if (isUploadingGallery)
                    {
                        <p><em>Uploading images...</em></p>
                    }

                    @foreach (var image in productViewModel.Gallery)
                    {
                        <div class="input-row" style="margin-bottom: 10px; align-items: center;">
                            <span style="color: #fff; margin-right: 10px;">Img:</span>
                            <InputText class="form-control-dark" @bind-Value="image.ImageUrl" placeholder="Image URL" style="flex: 1;" />
                            
                            @if (!string.IsNullOrEmpty(image.ImageUrl))
                            {
                                <div style="width: 50px; height: 38px; margin: 0 10px; overflow: hidden; border: 1px solid #555;">
                                    <img src="@image.ImageUrl" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'" />
                                </div>
                            }

                            <button type="button" class="btn-cancel" style="background-color: #dc3545; border:none;" @onclick="() => RemoveGalleryImage(image)">
                                X
                            </button>
                        </div>
                    }
                </div>
                <div class="form-group featured-group">
                    <label>Featured:</label>
                    <div class="featured-options">
                        <InputRadioGroup @bind-Value="productViewModel.IsFeatured">
                            <div class="form-check">
                                <InputRadio class="form-check-input" id="featuredYes" Value="true" />
                                <label class="form-check-label" for="featuredYes">Yes</label>
                            </div>
                            <div class="form-check">
                                <InputRadio class="form-check-input" id="featuredNo" Value="false" />
                                <label class="form-check-label" for="featuredNo">No</label>
                            </div>
                        </InputRadioGroup>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-saved" disabled="@(isUploadingMain || isUploadingGallery)">Update</button>
                    <button type="button" class="btn-cancel" @onclick='() => NavigationManager.NavigateTo("/admin/products")'>Cancel</button>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public int ProductId { get; set; }
    private ProductViewModel? productViewModel;
    private List<string> SeasonYears { get; set; } = new();
    private const long MaxFileSize = 1024 * 1024 * 10;
    private bool isUploadingMain = false;
    private bool isUploadingGallery = false;

    protected override async Task OnInitializedAsync()
    {
        int startYear = 2014;
        int currentYear = DateTime.Now.Year;
        for (int year = startYear; year <= currentYear; year++)
        {
            SeasonYears.Add($"{year}/{year + 1}");
        }
        SeasonYears.Reverse();

        // Include the Gallery when fetching
        var product = await DbContext.Products
            .Include(p => p.Gallery)
            .FirstOrDefaultAsync(p => p.ProductId == ProductId);

        if (product != null)
        {
            productViewModel = new ProductViewModel
            {
                Name = product.Name,
                Price = product.Price,
                Category = product.Category,
                Stock = product.Stock,
                Description = product.Description,
                IsFeatured = product.IsFeatured,
                ImageUrl = product.ImageUrl,
                
                // Copy existing gallery
                Gallery = product.Gallery.ToList() 
            };

            // Parse Season (existing logic)
            if (!string.IsNullOrEmpty(product.Season) && product.Season.Contains(" (") && product.Season.EndsWith(")"))
            {
                var parts = product.Season.Split(new[] { " (" }, StringSplitOptions.None);
                if (parts.Length == 2)
                {
                    productViewModel.SeasonType = parts[0];
                    productViewModel.SeasonYear = parts[1].TrimEnd(')');
                }
            }
            else if (!string.IsNullOrEmpty(product.Season))
            {
                productViewModel.SeasonType = product.Season;
                productViewModel.SeasonYear = string.Empty;
            }
        }
    }

    private async Task LoadMainImage(InputFileChangeEventArgs e)
    {
        isUploadingMain = true;
        try
        {
            var url = await UploadFileAsync(e.File);
            productViewModel.ImageUrl = url;
        }
        finally { isUploadingMain = false; }
    }

    private async Task LoadGalleryImages(InputFileChangeEventArgs e)
    {
        isUploadingGallery = true;
        try
        {
            foreach (var file in e.GetMultipleFiles(10))
            {
                var url = await UploadFileAsync(file);
                productViewModel.Gallery.Add(new ProductImage { ImageUrl = url, ProductId = ProductId });
            }
        }
        finally { isUploadingGallery = false; }
    }

    private async Task<string> UploadFileAsync(IBrowserFile file)
    {
        var fileExtension = Path.GetExtension(file.Name);
        var trustedFileName = $"{Guid.NewGuid()}{fileExtension}";
        var uploadPath = Path.Combine(Environment.WebRootPath, "Images", "products");
        Directory.CreateDirectory(uploadPath);
        var filePath = Path.Combine(uploadPath, trustedFileName);

        await using FileStream fs = new(filePath, FileMode.Create);
        await file.OpenReadStream(MaxFileSize).CopyToAsync(fs);

        return $"/Images/products/{trustedFileName}";
    }

    private void AddEmptyGallerySlot() => productViewModel.Gallery.Add(new ProductImage());
    
    private void RemoveGalleryImage(ProductImage image) => productViewModel.Gallery.Remove(image);

    private async Task HandleUpdateSubmit()
    {
        var productToUpdate = await DbContext.Products
            .Include(p => p.Gallery)
            .FirstOrDefaultAsync(p => p.ProductId == ProductId);

        if (productToUpdate == null || productViewModel == null) return;

        productToUpdate.Name = productViewModel.Name;
        productToUpdate.Price = productViewModel.Price;
        productToUpdate.Category = productViewModel.Category;
        productToUpdate.Stock = productViewModel.Stock;
        productToUpdate.Description = productViewModel.Description;
        productToUpdate.IsFeatured = productViewModel.IsFeatured;
        productToUpdate.ImageUrl = productViewModel.ImageUrl;

        productToUpdate.Season = !string.IsNullOrEmpty(productViewModel.SeasonType)
                                     ? $"{productViewModel.SeasonType}{(!string.IsNullOrEmpty(productViewModel.SeasonYear) ? $" ({productViewModel.SeasonYear})" : "")}"
                                     : null;

        // Update Gallery
        // 1. Remove images not in ViewModel
        var validIds = productViewModel.Gallery.Where(g => g.Id != 0).Select(g => g.Id).ToList();
        var toRemove = productToUpdate.Gallery.Where(g => !validIds.Contains(g.Id)).ToList();
        DbContext.ProductImages.RemoveRange(toRemove);

        // 2. Add new images
        foreach (var imgVM in productViewModel.Gallery)
        {
            if (imgVM.Id == 0 && !string.IsNullOrWhiteSpace(imgVM.ImageUrl))
            {
                productToUpdate.Gallery.Add(new ProductImage { ImageUrl = imgVM.ImageUrl });
            }
            // Existing images are already tracked or don't need updates if they are just URLs
        }

        await DbContext.SaveChangesAsync();
        NavigationManager.NavigateTo("/admin/products");
    }
}