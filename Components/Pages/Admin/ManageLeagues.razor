@page "/admin/leagues"
@using MaillotStore.Data
@using MaillotStore.Services.Interfaces
@inject ILeagueService LeagueService
@layout MaillotStore.Components.Layout.AdminLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

<PageTitle>Manage Leagues</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Leagues</h2>
        <button class="btn btn-primary" @onclick="OpenAddModal">
            <i class="bi bi-plus-lg"></i> Add New League
        </button>
    </div>

    @if (leagues == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="row">
            @foreach (var league in leagues)
            {
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">@league.Name</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => EditLeague(league)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteLeague(league.Id)">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showModal)
{
    <div class="modal show d-block" style="background: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(editingLeague.Id == 0 ? "Add League" : "Edit League")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="editingLeague" OnValidSubmit="SaveLeague">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label class="form-label">League Name</label>
                            <InputText @bind-Value="editingLeague.Name" class="form-control" placeholder="e.g. Premier League" />
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Save</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<League> leagues;
    private League editingLeague = new();
    private bool showModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadLeagues();
    }

    private async Task LoadLeagues()
    {
        leagues = await LeagueService.GetAllLeaguesAsync();
    }

    private void OpenAddModal()
    {
        editingLeague = new League();
        showModal = true;
    }

    private void EditLeague(League league)
    {
        editingLeague = new League { Id = league.Id, Name = league.Name };
        showModal = true;
    }

    private void CloseModal() => showModal = false;

    private async Task SaveLeague()
    {
        if (editingLeague.Id == 0)
            await LeagueService.AddLeagueAsync(editingLeague);
        else
            await LeagueService.UpdateLeagueAsync(editingLeague);

        await LoadLeagues();
        CloseModal();
    }

    private async Task DeleteLeague(int id)
    {
        await LeagueService.DeleteLeagueAsync(id);
        await LoadLeagues();
    }
}