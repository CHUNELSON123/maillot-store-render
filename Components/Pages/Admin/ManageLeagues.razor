@page "/admin/leagues"
@using MaillotStore.Data
@using MaillotStore.Services.Interfaces
@inject ILeagueService LeagueService
@layout MaillotStore.Components.Layout.AdminLayout
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

<PageTitle>Manage Leagues</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Leagues</h2>
        <button class="btn btn-primary" @onclick="OpenAddModal">
            <i class="bi bi-plus-lg"></i> Add New League
        </button>
    </div>

    @if (leagues == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="row">
            @foreach (var league in leagues)
            {
                <div class="col-md-4 mb-3">
                    @* --- FIX: Added dark background style so text is visible --- *@
                    <div class="card shadow-sm" style="background-color: #1a1a1a; border: 1px solid #444; color: white; @(league.IsDiscountActive ? "border-color: #28a745;" : "")">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-0">@league.Name</h5>
                                @* Show Sale Badge if active *@
                                @if (league.IsDiscountActive)
                                {
                                    <small class="text-success fw-bold" style="display:block; font-size: 0.8rem;">SALE: -@league.DiscountPercentage%</small>
                                }
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" @onclick="() => EditLeague(league)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteLeague(league.Id)">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showModal)
{
    <div class="modal show d-block" style="background: rgba(0,0,0,0.8);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content" style="background-color: #1a1a1a; color: white; border: 1px solid #444;">
                <div class="modal-header" style="border-bottom: 1px solid #444;">
                    <h5 class="modal-title">@(editingLeague.Id == 0 ? "Add League" : "Edit League")</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="editingLeague" OnValidSubmit="SaveLeague">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label class="form-label" style="color: #ccc;">League Name</label>
                            <InputText @bind-Value="editingLeague.Name" class="form-control" style="background-color: #333; color: white; border: 1px solid #555;" />
                        </div>

                        @* --- DISCOUNT SECTION --- *@
                        <div style="background-color: #2a2a2a; padding: 10px; border-radius: 5px; border: 1px solid #555; margin-bottom: 15px;">
                            <label style="color: #0d6efd; font-weight: bold; margin-bottom: 5px;">League-Wide Sale</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="small text-muted">Discount %</label>
                                    <InputNumber @bind-Value="editingLeague.DiscountPercentage" class="form-control" style="background-color: #333; color: white; border: 1px solid #555;" />
                                </div>
                                <div class="col-6 d-flex align-items-end pb-2">
                                    <div class="form-check">
                                        <InputCheckbox @bind-Value="editingLeague.IsDiscountActive" class="form-check-input" id="leagueSaleActive" />
                                        <label class="form-check-label text-white" for="leagueSaleActive">Activate</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Save</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<League> leagues;
    private League editingLeague = new();
    private bool showModal = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadLeagues();
    }

    private async Task LoadLeagues()
    {
        leagues = await LeagueService.GetAllLeaguesAsync();
    }

    private void OpenAddModal()
    {
        editingLeague = new League();
        showModal = true;
    }

    private void EditLeague(League league)
    {
        editingLeague = new League
        {
            Id = league.Id,
            Name = league.Name,
            DiscountPercentage = league.DiscountPercentage,
            IsDiscountActive = league.IsDiscountActive
        };
        showModal = true;
    }

    private void CloseModal() => showModal = false;

    private async Task SaveLeague()
    {
        if (editingLeague.Id == 0)
            await LeagueService.AddLeagueAsync(editingLeague);
        else
            await LeagueService.UpdateLeagueAsync(editingLeague);

        await LoadLeagues();
        CloseModal();
    }

    private async Task DeleteLeague(int id)
    {
        await LeagueService.DeleteLeagueAsync(id);
        await LoadLeagues();
    }
}