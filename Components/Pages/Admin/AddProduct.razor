@page "/admin/add-product"
@using System.IO
@using MaillotStore.Components.Layout
@using MaillotStore.Data
@using MaillotStore.Models
@using MaillotStore.ViewModels
@using MaillotStore.Services.Interfaces
@using Microsoft.AspNetCore.Authorization
@layout AdminLayout
@inject ApplicationDbContext DbContext
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment Environment
@inject ILogger<AddProduct> Logger
@inject ITeamService TeamService
@inject ILeagueService LeagueService
@attribute [Authorize(Roles = "Admin")]

<PageTitle>Add Product</PageTitle>

<div class="add-product-container">
    <div class="add-product-header">
        <h1>Add New Product</h1>
        <button class="back-btn" @onclick='() => NavigationManager.NavigateTo("/admin/products")'>Back</button>
    </div>

    <div class="add-product-form-body">
        <EditForm Model="@productViewModel" OnValidSubmit="HandleValidSubmit" enctype="multipart/form-data">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label for="productName">Product Name:</label>
                <InputText id="productName" class="form-control-dark" @bind-Value="productViewModel.Name" />
                <ValidationMessage For="@(() => productViewModel.Name)" />
            </div>

            <div class="form-group">
                <label for="productPrice">Price:</label>
                <InputNumber id="productPrice" class="form-control-dark" @bind-Value="productViewModel.Price" />
                <ValidationMessage For="@(() => productViewModel.Price)" />
            </div>

            <div class="form-group">
                <label for="productCategory">Category:</label>
                <InputSelect id="productCategory" class="form-control-dark" @bind-Value="productViewModel.Category">
                    <option value="">Select Category</option>
                    <option value="Football">Football</option>
                    <option value="Basketball">Basketball</option>
                    <option value="NFL">NFL</option>
                </InputSelect>
                <ValidationMessage For="@(() => productViewModel.Category)" />
            </div>

            @* --- NEW: JERSEY VERSION DROPDOWN --- *@
            <div class="form-group">
                <label for="productVersion">Jersey Version (Optional):</label>
                <InputSelect id="productVersion" class="form-control-dark" @bind-Value="productViewModel.Version">
                    <option value="">-- None / Standard --</option>
                    <option value="Fan Version">Fan Version</option>
                    <option value="Player Version">Player Version</option>
                    <option value="Retro">Retro</option>
                    <option value="Training">Training</option>
                </InputSelect>
            </div>
            @* ------------------------------------ *@

            @* --- LEAGUE FILTER (Helper) --- *@
            <div class="form-group">
                <label>Filter Teams by League (Optional Helper):</label>
                <select class="form-control-dark" @bind="selectedLeagueId">
                    <option value="0">-- All Leagues --</option>
                    @if (leagues != null)
                    {
                        @foreach (var league in leagues)
                        {
                            <option value="@league.Id">@league.Name</option>
                        }
                    }
                </select>
            </div>

            <div class="form-group">
                <label for="productTeam">Team (Optional):</label>
                <InputSelect id="productTeam" class="form-control-dark" @bind-Value="productViewModel.TeamId">
                    <option value="">-- Select Team --</option>
                    @if (filteredTeams != null)
                    {
                        @foreach (var team in filteredTeams)
                        {
                            <option value="@team.Id">@team.Name</option>
                        }
                    }
                </InputSelect>
            </div>

            <div class="form-group">
                <label for="jerseySeason">Jersey Season:</label>
                <div class="season-inputs">
                    <InputSelect class="form-control-dark" @bind-Value="productViewModel.SeasonType">
                        <option value="">Select Type</option>
                        <option value="HOME">HOME</option>
                        <option value="AWAY">AWAY</option>
                        <option value="THIRD">THIRD</option>
                    </InputSelect>
                    <InputSelect class="form-control-dark" @bind-Value="productViewModel.SeasonYear">
                        <option value="">Select Year</option>
                        @foreach (var year in SeasonYears)
                        {
                            <option value="@year">@year</option>
                        }
                    </InputSelect>
                </div>
            </div>

            <div class="form-group">
                <label for="stockQuantity">Stock Quantity:</label>
                <InputNumber id="stockQuantity" class="form-control-dark" @bind-Value="productViewModel.Stock" />
            </div>

            <div class="form-group">
                <label for="productDescription">Description (Optional):</label>
                <InputTextArea id="productDescription" class="form-control-dark" rows="5" @bind-Value="productViewModel.Description" />
            </div>

            <div class="form-group">
                <label style="font-weight:bold; margin-bottom: 8px; display:block;">Main Product Image</label>
                <div class="input-row" style="gap: 10px; align-items: center;">
                    <InputText class="form-control-dark" @bind-Value="productViewModel.ImageUrl" placeholder="Paste URL or upload file..." style="flex: 1;" />
                    <label class="btn-saved" style="cursor: pointer; margin:0; padding: 10px 15px; display:flex; align-items:center;">
                        @if (isUploadingMain)
                        {
                            <span>Uploading...</span>
                        }
                        else
                        {

                            <span>Upload</span>
                        }
                        <InputFile OnChange="LoadMainImage" hidden accept=".jpg,.jpeg,.png,.webp" />
                    </label>
                </div>
                @if (!string.IsNullOrEmpty(productViewModel.ImageUrl))
                {
                    <div style="margin-top: 10px; border: 1px solid #444; padding: 5px; border-radius: 4px; display: inline-block;">
                        <img src="@productViewModel.ImageUrl" style="max-height: 150px; object-fit: cover;" />
                    </div>
                }
            </div>

            <div class="form-group">
                <label style="font-weight:bold; margin-bottom: 8px; display:block;">Gallery Images (Unlimited)</label>
                <div style="margin-bottom: 10px;">
                    <label class="btn-saved" style="cursor: pointer; margin-right: 10px;">
                        + Upload Multiple Images
                        <InputFile OnChange="LoadGalleryImages" multiple hidden accept=".jpg,.jpeg,.png,.webp" />
                    </label>
                    <button type="button" class="btn-cancel" @onclick="AddEmptyGallerySlot">
                        + Add URL Manually
                    </button>
                </div>

                @if (isUploadingGallery)
                {
                    <p><em>Uploading images...</em></p>
                }

                @foreach (var image in productViewModel.Gallery)
                {
                    <div class="input-row" style="margin-bottom: 10px; align-items: center;">
                        <span style="color: #fff; margin-right: 10px;">Img:</span>
                        <InputText class="form-control-dark" @bind-Value="image.ImageUrl" placeholder="Image URL" style="flex: 1;" />
                        @if (!string.IsNullOrEmpty(image.ImageUrl))
                        {
                            <div style="width: 50px; height: 38px; margin: 0 10px; overflow: hidden; border: 1px solid #555;">
                                <img src="@image.ImageUrl" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'" />
                            </div>
                        }
                        <button type="button" class="btn-cancel" style="background-color: #dc3545; border:none;" @onclick="() => RemoveGalleryImage(image)">X</button>
                    </div>
                }
            </div>

            <div class="form-group featured-group">
                <label>Featured:</label>
                <div class="featured-options">
                    <InputRadioGroup @bind-Value="productViewModel.IsFeatured">
                        <div class="form-check">
                            <InputRadio class="form-check-input" id="featuredYes" Value="true" />
                            <label class="form-check-label" for="featuredYes">Yes</label>
                        </div>
                        <div class="form-check">
                            <InputRadio class="form-check-input" id="featuredNo" Value="false" />
                            <label class="form-check-label" for="featuredNo">No</label>
                        </div>
                    </InputRadioGroup>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-saved" disabled="@(isUploadingMain || isUploadingGallery)">Save</button>
                <button type="button" class="btn-cancel" @onclick='() => NavigationManager.NavigateTo("/admin/products")'>Cancel</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private ProductViewModel productViewModel = new();
    private List<string> SeasonYears { get; set; } = new();

    // Data Loading
    private List<Team> allTeams = new();
    private List<League> leagues = new();
    private int selectedLeagueId = 0;

    private IEnumerable<Team> filteredTeams =>
        selectedLeagueId == 0 ? allTeams : allTeams.Where(t => t.LeagueId == selectedLeagueId);

    private const long MaxFileSize = 1024 * 1024 * 10;
    private bool isUploadingMain = false;
    private bool isUploadingGallery = false;

    protected override async Task OnInitializedAsync()
    {
        leagues = await LeagueService.GetAllLeaguesAsync();
        allTeams = await TeamService.GetAllTeamsAsync();

        int startYear = 2014;
        int currentYear = DateTime.Now.Year;
        for (int year = startYear; year <= currentYear; year++)
        {
            SeasonYears.Add($"{year}/{year + 1}");
        }
        SeasonYears.Reverse();
    }

    private async Task LoadMainImage(InputFileChangeEventArgs e)
    {
        isUploadingMain = true;
        try { productViewModel.ImageUrl = await UploadFileAsync(e.File); }
        catch (Exception ex) { Logger.LogError(ex, "Error uploading main image"); }
        finally { isUploadingMain = false; }
    }

    private async Task LoadGalleryImages(InputFileChangeEventArgs e)
    {
        isUploadingGallery = true;
        try
        {
            foreach (var file in e.GetMultipleFiles(10))
            {
                var url = await UploadFileAsync(file);
                productViewModel.Gallery.Add(new ProductImage { ImageUrl = url });
            }
        }
        catch (Exception ex) { Logger.LogError(ex, "Error uploading gallery images"); }
        finally { isUploadingGallery = false; }
    }

    private async Task<string> UploadFileAsync(IBrowserFile file)
    {
        var fileExtension = Path.GetExtension(file.Name);
        var trustedFileName = $"{Guid.NewGuid()}{fileExtension}";
        var uploadPath = Path.Combine(Environment.WebRootPath, "Images", "products");
        Directory.CreateDirectory(uploadPath);
        var filePath = Path.Combine(uploadPath, trustedFileName);
        await using FileStream fs = new(filePath, FileMode.Create);
        await file.OpenReadStream(MaxFileSize).CopyToAsync(fs);
        return $"/Images/products/{trustedFileName}";
    }

    private void AddEmptyGallerySlot() => productViewModel.Gallery.Add(new ProductImage());
    private void RemoveGalleryImage(ProductImage image) => productViewModel.Gallery.Remove(image);

    private async Task HandleValidSubmit()
    {
        var newProduct = new Product
        {
            Name = productViewModel.Name ?? string.Empty,
            Price = productViewModel.Price,
            Category = productViewModel.Category ?? string.Empty,
            Stock = productViewModel.Stock,
            Description = productViewModel.Description ?? string.Empty,
            IsFeatured = productViewModel.IsFeatured,
            ImageUrl = productViewModel.ImageUrl ?? string.Empty,
            TeamId = productViewModel.TeamId,
            Size = "S,M,L,XL,XXL",

            // --- SAVE VERSION ---
            Version = productViewModel.Version,
            // --------------------

            Season = !string.IsNullOrEmpty(productViewModel.SeasonType)
                        ? $"{productViewModel.SeasonType}{(!string.IsNullOrEmpty(productViewModel.SeasonYear) ? $" ({productViewModel.SeasonYear})" : "")}"
                        : null
        };

        var cleanGallery = productViewModel.Gallery.Where(i => !string.IsNullOrWhiteSpace(i.ImageUrl)).ToList();
        newProduct.Gallery = cleanGallery;

        DbContext.Products.Add(newProduct);
        await DbContext.SaveChangesAsync();
        NavigationManager.NavigateTo("/admin/products");
    }
}