@using MaillotStore.Services.Implementations
@using MaillotStore.Services.Interfaces
@using MaillotStore.Data
@using MaillotStore.Components.Shared
@using System.Timers
@inherits LayoutComponentBase
@implements IDisposable
@inject ISearchStateService SearchState
@inject ReferralService ReferralService
@inject NavigationManager NavManager
@inject ILeagueService LeagueService
@inject IJSRuntime JSRuntime
@inject ICartService CartService

<header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid align-items-center">
            <a class="navbar-brand d-flex align-items-center" href="">
                <img src="/Images/maillotstore-logo.jpeg" alt="Maillot Store Logo" class="logo">
                <span class="brand-text ms-2">Maillot Store</span>
            </a>

            @* --- DESKTOP MENU --- *@
            <div class="collapse navbar-collapse" id="main-nav-desktop">

                @* --- DESKTOP SEARCH BAR WITH "CLEAR" X BUTTON --- *@
                <div class="search-container mx-auto d-none d-lg-block position-relative" style="border-radius: 500px;">
                    <input type="text" class="form-control search-bar" placeholder="Search for jerseys..."
                           @bind="SearchTerm" @bind:event="oninput" style="padding-right: 35px;" />
                    @if (!string.IsNullOrEmpty(SearchTerm))
                    {
                        <i class="fas fa-times position-absolute"
                           style="right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: gray;"
                           @onclick="ClearSearch"></i>
                    }
                </div>

                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/shop">Shop</a></li>

                    @* --- DESKTOP MEGA MENU --- *@
                    <li class="nav-item dropdown mega-menu-item">
                        <a class="nav-link dropdown-toggle" href="#" id="clubDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Club
                        </a>
                        <div class="dropdown-menu mega-menu" aria-labelledby="clubDropdown">
                            <div class="container">
                                <div class="row justify-content-center">
                                    @if (leaguesList != null)
                                    {
                                        @foreach (var league in leaguesList)
                                        {
                                            <div class="col-md-3 mb-4 text-center">
                                                <h6 class="dropdown-header text-uppercase text-warning fw-bold">
                                                    @league.Name
                                                </h6>
                                                <ul class="list-unstyled">
                                                    @foreach (var team in league.Teams)
                                                    {
                                                        <li>
                                                            <a class="dropdown-item text-center" href="/shop?teamId=@team.Id">
                                                                @team.Name
                                                            </a>
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </li>

                    <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="/contact">Contact</a></li>
                    <li class="nav-item"><a class="nav-link" href="/checkout">Checkout</a></li>

                    <AuthorizeView>
                        <Authorized>
                            @if (context.User.IsInRole("Influencer"))
                            {
                                <li class="nav-item"><a class="nav-link" href="/influencer-dashboard">Dashboard</a></li>
                            }
                            else if (context.User.IsInRole("Admin"))
                            {
                                <li class="nav-item"><a class="nav-link" href="/admin/dashboard">Dashboard</a></li>
                            }
                            <li class="nav-item">
                                <form action="/Account/Logout" method="post">
                                    <AntiforgeryToken />
                                    <input type="hidden" name="returnUrl" value="/" />
                                    <button type="submit" class="nav-link btn btn-link">Logout</button>
                                </form>
                            </li>
                        </Authorized>
                        <NotAuthorized>
                            @if (!isReferred)
                            {
                                <li class="nav-item"><a class="nav-link" href="/Account/Login">Login</a></li>
                            }
                        </NotAuthorized>
                    </AuthorizeView>
                </ul>
            </div>

            @* --- MOBILE ICONS --- *@
            <div class="mobile-icons-container d-lg-none">
                <button class="btn btn-link nav-link search-icon-mobile" @onclick="ToggleMobileSearch">
                    <i class="fas fa-search"></i>
                </button>
                <button class="navbar-toggler" type="button" @onclick="ToggleNavMenu">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        </div>
    </nav>

    @* --- MOBILE SEARCH BAR --- *@
    @if (showMobileSearch)
    {
        <div class="search-container-mobile d-lg-none px-3 py-2 d-flex align-items-center gap-2">
            <div class="position-relative flex-grow-1">
                <input type="text" class="form-control search-bar w-100" placeholder="Search for jerseys..."
                       @bind="SearchTerm" @bind:event="oninput" style="padding-right: 35px;" />
                @if (!string.IsNullOrEmpty(SearchTerm))
                {
                    <i class="fas fa-times position-absolute"
                       style="right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: gray;"
                       @onclick="ClearSearch"></i>
                }
            </div>
            <button class="btn-close btn-close-white" @onclick="ToggleMobileSearch"></button>
        </div>
    }
</header>

@if (!collapseNavMenu)
{
    <div class="sidenav-overlay" @onclick="ToggleNavMenu"></div>
}

@* --- MOBILE SLIDE-OUT MENU --- *@
<div class="@NavMenuCssClass">
    <div class="sidenav-content">
        <a href="javascript:void(0)" class="closebtn" @onclick="CloseNavMenu">&times;</a>

        <a class="nav-link" href="/" @onclick="CloseNavMenu">Home</a>
        <a class="nav-link" href="/shop" @onclick="CloseNavMenu">Shop</a>

        @* --- MOBILE COLLAPSIBLE CLUB MENU --- *@
        <div class="mobile-club-section">
            <button class="nav-link btn-reset w-100 text-start d-flex justify-content-between align-items-center"
                    @onclick="ToggleMobileClubMenu">
                Clubs
                <i class="fas fa-chevron-down @(showMobileClubMenu ? "rotate-180" : "")"></i>
            </button>

            @if (showMobileClubMenu && leaguesList != null)
            {
                <div class="mobile-club-dropdown">
                    @foreach (var league in leaguesList)
                    {
                        <div class="mobile-league-item">
                            <button class="league-header btn-reset w-100 text-start"
                                    @onclick="() => ToggleMobileLeague(league.Id)">
                                @league.Name
                                <i class="fas fa-plus small-icon @(expandedLeagueId == league.Id ? "d-none" : "")"></i>
                                <i class="fas fa-minus small-icon @(expandedLeagueId == league.Id ? "" : "d-none")"></i>
                            </button>

                            @if (expandedLeagueId == league.Id)
                            {
                                <div class="mobile-teams-list">
                                    @foreach (var team in league.Teams)
                                    {
                                        <a href="/shop?teamId=@team.Id" class="mobile-team-link" @onclick="CloseNavMenu">
                                            @team.Name
                                        </a>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>

        <a class="nav-link" href="/about" @onclick="CloseNavMenu">About</a>
        <a class="nav-link" href="/contact" @onclick="CloseNavMenu">Contact</a>
        <a class="nav-link" href="/checkout" @onclick="CloseNavMenu">Checkout</a>

        <AuthorizeView>
            <Authorized>
                @if (context.User.IsInRole("Influencer"))
                {
                    <a class="nav-link" href="/influencer-dashboard" @onclick="CloseNavMenu">Dashboard</a>
                }
                else if (context.User.IsInRole("Admin"))
                {
                    <a class="nav-link" href="/admin/dashboard" @onclick="CloseNavMenu">Dashboard</a>
                }
                <form action="/Account/Logout" method="post" class="w-100">
                    <AntiforgeryToken />
                    <input type="hidden" name="returnUrl" value="/" />
                    <button type="submit" class="nav-link btn btn-link text-start w-100" style="padding: 8px 8px 8px 32px;">Logout</button>
                </form>
            </Authorized>
            <NotAuthorized>
                @if (!isReferred)
                {
                    <a class="nav-link" href="/Account/Login" @onclick="CloseNavMenu">Login</a>
                }
            </NotAuthorized>
        </AuthorizeView>
    </div>
</div>

<main>
    @Body
</main>
<Footer />

<MaillotStore.Components.Pages.StoreFront.CookieBanner />

@code {
    private bool collapseNavMenu = true;
    private bool showMobileSearch = false;
    private bool isReferred;
    private List<League> leaguesList = new();
    private bool showMobileClubMenu = false;
    private int expandedLeagueId = 0;

    // --- DEBOUNCE TIMER LOGIC ---
    private Timer? searchTimer;
    private string _searchTerm = string.Empty;

    public string SearchTerm
    {
        get => _searchTerm;
        set
        {
            _searchTerm = value;

            searchTimer?.Stop();
            searchTimer?.Start();
        }
    }

    private string NavMenuCssClass => collapseNavMenu ? "sidenav" : "sidenav open";

    protected override async Task OnInitializedAsync()
    {
        isReferred = ReferralService.IsReferred();
        leaguesList = await LeagueService.GetAllLeaguesAsync();

        searchTimer = new Timer(400);
        searchTimer.AutoReset = false;
        searchTimer.Elapsed += ExecuteSearch;
    }

    private void ExecuteSearch(object? sender, ElapsedEventArgs e)
    {
        InvokeAsync(() =>
        {
            SearchState.SetSearchTerm(SearchTerm);

            if (!NavManager.Uri.Contains("/shop", StringComparison.OrdinalIgnoreCase) && !string.IsNullOrWhiteSpace(SearchTerm))
            {
                NavManager.NavigateTo("/shop");
            }
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var guestId = await JSRuntime.InvokeAsync<string>("cookieHelper.getCookie", "GuestId");
                if (string.IsNullOrEmpty(guestId))
                {
                    guestId = Guid.NewGuid().ToString();
                    await JSRuntime.InvokeVoidAsync("cookieHelper.setCookie", "GuestId", guestId, 30);
                }
                CartService.SetGuestId(guestId);
            }
            catch (Exception)
            {
                CartService.SetGuestId(Guid.NewGuid().ToString());
            }

            try
            {
                if (!ReferralService.IsReferred())
                {
                    var cookieRefCode = await JSRuntime.InvokeAsync<string>("cookieHelper.getCookie", "MaillotStoreReferralCode");
                    if (!string.IsNullOrEmpty(cookieRefCode))
                    {
                        ReferralService.SetReferralCode(cookieRefCode);
                        isReferred = true;
                        StateHasChanged();
                    }
                }
            }
            catch (Exception)
            {
            }
        }
    }

    // --- NEW: Method to clear the search instantly ---
    private void ClearSearch()
    {
        SearchTerm = string.Empty;
        SearchState.SetSearchTerm(string.Empty);
    }

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
        if (showMobileSearch) showMobileSearch = false;
    }

    private void ToggleMobileSearch()
    {
        showMobileSearch = !showMobileSearch;
        if (collapseNavMenu == false) collapseNavMenu = true;

        // --- FIX: Clear search if mobile search bar is closed ---
        if (!showMobileSearch)
        {
            ClearSearch();
        }
    }

    private void CloseNavMenu()
    {
        collapseNavMenu = true;
        showMobileClubMenu = false;
        expandedLeagueId = 0;
    }

    private void ToggleMobileClubMenu()
    {
        showMobileClubMenu = !showMobileClubMenu;
    }

    private void ToggleMobileLeague(int leagueId)
    {
        if (expandedLeagueId == leagueId)
            expandedLeagueId = 0;
        else
            expandedLeagueId = leagueId;
    }

    public void Dispose()
    {
        searchTimer?.Dispose();
    }
}